tosca_definitions_version: tosca_2_0

imports:
  - url: https://raw.githubusercontent.com/xDaryamo/tosca-community-contributions/refs/heads/master/profiles/org/oasis-open/simple/2.0/profile.yaml
    namespace: tosca

metadata:
  template_name: Policies and Groups Example
  template_author: Puccini


policy_types:

  Backup:
    targets:
    # Can include both node types and group types
    - tosca:Compute
    - RedundantResources

  ContinuousBackup:
    derived_from: Backup
    properties:
      frequency:
        type: tosca:Time
    # Targets are inherited

  ContinuousBlockStorageBackup:
    derived_from: ContinuousBackup
    targets:
    - tosca:Compute
    - RedundantBlockStorages

group_types:

  Redundants:
    properties:
      priority:
        type: float

  RedundantResources:
    derived_from: Redundants
    members:
    - tosca:Compute
    - tosca:Abstract.Storage

  RedundantBlockStorages:
    derived_from: RedundantResources
    members:
    - tosca:Storage.BlockStorage

interface_types:

  Backup:
    operations:
      start_backup: {}

node_types:

  SuperCompute:
    derived_from: tosca:Compute
    interfaces:
      backup:
        type: Backup

service_template:

  node_templates:

    server1:
      type: tosca:Compute

    server2:
      type: tosca:Compute

    server3:
      type: tosca:Compute

    server4:
      type: SuperCompute

    storage:
      type: tosca:Storage.ObjectStorage
      properties:
        name: My Storage
        size: 10 GiB
        maxsize: 20 GiB


  groups:

    redundants:
      type: RedundantResources
      properties:
        priority: 0.8
      members:
      - server3
      - server4
      - storage

  policies:

  - backup:
      type: ContinuousBackup
      properties:
        frequency: 0.5 d
      triggers:
        backup:
          event: power-failure
          condition:
            $or:
              - $match: [ $private_address, '^192\.168\.1\..+' ]
              - $match: [ $private_address, '^192\.168\.2\..+' ]
          action:
            - call_operation: Backup.start_backup
      targets:
      - server2
      - redundants
