tosca_definitions_version: tosca_2_0

imports:
  - url: https://raw.githubusercontent.com/xDaryamo/tosca-community-contributions/refs/heads/master/profiles/org/oasis-open/simple/2.0/profile.yaml
    namespace: tosca

metadata:
  template_name: Functions Example
  template_author: Puccini

node_types:
  Ports:
    properties:
      user-port:
        type: tosca:PortInfo
        required: false
      admin-port:
        type: tosca:PortInfo
        required: false
      management-port:
        type: tosca:PortInfo
        required: false
    capabilities:
      ingress: Ingress
    requirements:
      - egress:
          capability: Ingress
          relationship: Connection

capability_types:
  Ingress:
    properties:
      ingress_port:
        type: tosca:PortInfo
        required: false

relationship_types:
  Connection:
    properties:
      connection_port:
        type: tosca:PortInfo
        required: false

service_template:
  node_templates:

    ports1:
      type: Ports
      properties:
        user-port:
          mac_address: 00:00:00:00:00:01
          network_id: net1
          port_id: port1
          port_name: user-port
          addresses:
            - { $concat: [ local, host ] }
            - { $token: [ ip=10.0.0.2, =, 1 ] }
            - { $join: [ [ 192, 168, 1, 1 ], . ] }
            - { $concat: [ 127, ".", 0, ".", { $concat: [ 0, ".", 1 ] } ] }
            - $concat:
              - '::'
              - 1

        admin-port:
          mac_address: 00:00:00:00:00:02
          network_id: net1
          port_id: port2
          port_name: admin-port
          addresses:
            - ::1

        management-port:
          mac_address: 00:00:00:00:00:03
          network_id: net1
          port_id: port3
          port_name: mgmt-port
          addresses:
            - ::1

      capabilities:
        ingress:
          properties:
            ingress_port:
              mac_address: 00:00:00:00:00:10
              network_id: net-ingress
              port_id: port-ingress
              port_name: ingress-port
              addresses:
                - 192.168.1.2

    ports2:
      type: Ports
      properties:
        user-port:
          mac_address: 00:00:00:00:00:04
          network_id: net2
          port_id: port4
          port_name: user2
          addresses:
            - { $get_property: [ ports1, user-port, addresses, 0 ] }
            - { $get_property: [ ports1, user-port, addresses, 1 ] }

        management-port:
          mac_address: 00:00:00:00:00:05
          network_id: net2
          port_id: port5
          port_name: mgmt2
          addresses:
            - { $get_property: [ ports1, management-port, addresses, 0 ] }
            - { $get_property: [ ports1, ingress, ingress_port, addresses, 0 ] }
            - { $get_property: [ SELF, egress, 0, connection_port, addresses, 0 ] }

      requirements:
        - egress:
            node: ports1
            relationship:
              type: Connection
              properties:
                connection_port:
                  mac_address: 00:00:00:00:00:06
                  network_id: net-rel
                  port_id: port-rel
                  port_name: rel-port
                  addresses:
                    - 192.168.1.3
